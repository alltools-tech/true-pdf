<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PDF Toolkit — Compressor & Converter</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .container { max-width: 750px; margin: 3rem auto; }
    .fancy-title {
      font-family: 'Segoe UI', 'Arial', sans-serif;
      font-weight: 800;
      font-size: 2.5rem;
      background: linear-gradient(90deg, #377dff 40%, #ff6f6f 100%);
      color: transparent;
      background-clip: text;
      -webkit-background-clip: text;
      margin-bottom: 2rem;
      text-align: center;
      letter-spacing: 2px;
    }
    .drop-box {
      border: 2px dashed #377dff;
      background: #fff;
      border-radius: 12px;
      padding: 2.2rem;
      text-align: center;
      transition: border-color 0.3s, box-shadow 0.3s;
      cursor: pointer;
      position: relative;
    }
    .drop-box.dragover {
      border-color: #ff6f6f;
      box-shadow: 0 0 0 4px #ffe;
    }
    .drop-box input[type="file"] {
      display: none;
    }
    .drop-box label {
      display: block;
      font-weight: 600;
      color: #377dff;
      cursor: pointer;
      font-size: 1.15rem;
      margin-bottom: 0.6rem;
    }
    .file-info { margin-top: 1rem; }
    .slider-label { font-weight: 500; margin-bottom: 0.3rem; }
    .slider-value { font-weight: 600; margin-left: 6px; }
    .img-thumb { max-width: 100px; margin: 6px; border-radius: 6px; box-shadow: 0 2px 10px #eee; }
    .btn-group { margin-bottom: 1rem; }
    .output-options { margin-bottom: 1rem; }
    #downloadArea a { margin-bottom: 7px; }
  </style>
</head>
<body>
<div class="container">
  <div class="fancy-title">PDF Toolkit — Compressor & Converter</div>

  <!-- Stylish File Input with Drag & Drop -->
  <div id="drop" class="drop-box mb-3">
    <label for="file">Choose PDF or Image file<br><span style="font-size:0.95em;color:#888;">(or drag & drop here)</span></label>
    <input id="file" type="file" accept=".pdf,image/*" />
    <div id="fileSize" class="file-info"></div>
  </div>

  <!-- PDF to PDF Section -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">PDF Output Type:</label>
        <select id="pdfType" class="form-select">
          <option value="basic">Compress PDF (Basic)</option>
          <option value="ocr">OCR - Make PDF Searchable</option>
        </select>
      </div>
      <div class="mb-3" id="pdfSliderGroup">
        <label class="slider-label">Compression Quality:
          <span id="pdfQualityLabel" class="slider-value">80</span>
        </label>
        <input type="range" class="form-range" min="10" max="100" value="80" id="pdfQuality" />
        <div class="form-text">
          10 = Smallest file (low quality) &mdash; 100 = Largest file (best quality)
        </div>
      </div>
      <button id="goPDF" class="btn btn-primary mt-2">Convert PDF</button>
    </div>
  </div>

  <!-- PDF/Image to Images Section -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Image Output Format:</label>
        <select id="imgfmt" class="form-select">
          <option value="png">PNG</option>
          <option value="jpg">JPG</option>
          <option value="jpeg">JPEG</option>
          <option value="webp">WEBP</option>
          <option value="avif">AVIF</option>
          <option value="heic">HEIC</option>
          <option value="heif">HEIF</option>
          <option value="svg">SVG</option>
          <option value="tiff">TIFF</option>
          <option value="bmp">BMP</option>
        </select>
      </div>
      <div class="mb-3" id="imgSliderGroup">
        <label class="slider-label">Compression Quality:
          <span id="imgQualityLabel" class="slider-value">80</span>
        </label>
        <input type="range" class="form-range" min="10" max="100" value="80" id="imgQuality" />
        <div class="form-text">
          10 = Smallest file (low quality) &mdash; 100 = Largest file (best quality)
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Image Output Type:</label>
        <select id="imgouttype" class="form-select">
          <option value="images">Images (individual)</option>
          <option value="zip">Images (ZIP)</option>
        </select>
      </div>
      <button id="goIMG" class="btn btn-success mt-2">Convert to Images</button>
    </div>
  </div>

  <div id="log" class="mb-3"></div>
  <div id="downloadArea"></div>
</div>

<script>
let file = null;
const fileInput = document.getElementById('file');
const dropBox = document.getElementById('drop');
const logDiv = document.getElementById('log');
const downloadArea = document.getElementById('downloadArea');
const pdfQuality = document.getElementById('pdfQuality');
const pdfQualityLabel = document.getElementById('pdfQualityLabel');
const imgQuality = document.getElementById('imgQuality');
const imgQualityLabel = document.getElementById('imgQualityLabel');
const pdfTypeSelect = document.getElementById('pdfType');
const pdfSliderGroup = document.getElementById('pdfSliderGroup');

// --- Drag and Drop ---
dropBox.addEventListener('dragover', function(e) {
  e.preventDefault();
  dropBox.classList.add('dragover');
});
dropBox.addEventListener('dragleave', function(e) {
  dropBox.classList.remove('dragover');
});
dropBox.addEventListener('drop', function(e) {
  e.preventDefault();
  dropBox.classList.remove('dragover');
  if (e.dataTransfer.files && e.dataTransfer.files[0]) {
    file = e.dataTransfer.files[0];
    showFileSize(file);
    log('Selected: ' + file.name);
  }
});

// --- File input ---
fileInput.addEventListener('change', function(e) {
  file = e.target.files[0];
  showFileSize(file);
  log('Selected: ' + file.name);
});

// --- Slider label update ---
pdfQuality.addEventListener('input', function() {
  pdfQualityLabel.innerText = pdfQuality.value;
});
imgQuality.addEventListener('input', function() {
  imgQualityLabel.innerText = imgQuality.value;
});

// --- Hide PDF compression slider for OCR ---
pdfTypeSelect.addEventListener('change', function() {
  if (pdfTypeSelect.value === 'ocr') {
    pdfSliderGroup.style.display = 'none';
  } else {
    pdfSliderGroup.style.display = '';
  }
});

// --- Helpers ---
function showFileSize(f) {
  if (!f) { document.getElementById('fileSize').innerText = ''; return; }
  const kb = (f.size/1024).toFixed(2);
  const mb = (f.size/1024/1024).toFixed(2);
  document.getElementById('fileSize').innerText = `File size: ${kb} KB (${mb} MB)`;
}

function log(msg) {
  logDiv.innerText = msg;
}

function showCompressedSize(sz) {
  const kb = (sz/1024).toFixed(2);
  const mb = (sz/1024/1024).toFixed(2);
  logDiv.innerText += `\nOutput file size: ${kb} KB (${mb} MB)`;
}

function createDownloadLink(blob, fname, label) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fname;
  a.className = "btn btn-info mt-2";
  a.innerText = label || "Download";
  downloadArea.innerHTML = '';
  downloadArea.appendChild(a);
  setTimeout(()=>URL.revokeObjectURL(url), 60000);
}

function showImageDownloads(imgs, sizes) {
  const area = downloadArea;
  area.innerHTML = '';
  imgs.forEach((url, idx) => {
    const a = document.createElement('a');
    a.href = url;
    a.download = `page_${idx+1}.${document.getElementById('imgfmt').value}`;
    a.innerText = `Download page ${idx+1} (${(sizes[idx]/1024).toFixed(1)} KB)`;
    a.className = "btn btn-outline-success m-1";
    area.appendChild(a);
    area.appendChild(document.createElement('br'));
    const imgThumb = document.createElement('img');
    imgThumb.src = url;
    imgThumb.className = 'img-thumb';
    area.appendChild(imgThumb);
  });
}

// --- PDF Convert Button ---
document.getElementById('goPDF').addEventListener('click', async () => {
  if (!file) { alert('Select a PDF first'); return; }
  downloadArea.innerHTML = '';
  log('Uploading...');
  const form = new FormData();
  form.append('file', file);
  let endpoint = '';
  let params = {};
  if (pdfTypeSelect.value === 'basic') {
    endpoint = '/compress/basic';
    params = { quality: pdfQuality.value };
  } else if (pdfTypeSelect.value === 'ocr') {
    endpoint = '/ocr';
  }
  let url = endpoint;
  if (Object.keys(params).length) {
    url += '?' + new URLSearchParams(params).toString();
  }
  const resp = await fetch(url, { method: 'POST', body: form });
  if (!resp.ok) {
    const txt = await resp.text();
    log('Error: ' + resp.status + ' - ' + txt);
    return;
  }
  const blob = await resp.blob();
  const cd = resp.headers.get('content-disposition') || '';
  const m = cd.match(/filename=?"?([^"]+)"?/);
  let fname = m ? m[1] : 'output.pdf';
  showCompressedSize(blob.size);
  createDownloadLink(blob, fname, "Download PDF");
  log('Done: downloaded ' + fname);
});

// --- PDF/Image to Images Button ---
document.getElementById('goIMG').addEventListener('click', async () => {
  if (!file) { alert('Select a PDF or Image first'); return; }
  downloadArea.innerHTML = '';
  log('Uploading...');
  const form = new FormData();
  form.append('file', file);
  const fmt = document.getElementById('imgfmt').value;
  const outtype = document.getElementById('imgouttype').value;
  const imgQualityVal = imgQuality.value;
  let url = '/pdf-to-images?fmt=' + fmt + '&outtype=' + outtype + '&quality=' + imgQualityVal;
  const resp = await fetch(url, { method: 'POST', body: form });
  if (!resp.ok) {
    const txt = await resp.text();
    log('Error: ' + resp.status + ' - ' + txt);
    return;
  }
  if (outtype === "images") {
    const result = await resp.json();
    log('Converted images:');
    showImageDownloads(result.images, result.sizes);
  } else {
    const blob = await resp.blob();
    showCompressedSize(blob.size);
    createDownloadLink(blob, "pages.zip", "Download ZIP");
    log('Done: downloaded images ZIP');
  }
});
</script>
</body>
</html>