<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PDF Toolkit — Compressor & Converter</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .container { max-width: 830px; margin: 3rem auto; }
    .fancy-title {
      font-family: 'Segoe UI', 'Arial', sans-serif;
      font-weight: 800;
      font-size: 2.5rem;
      background: linear-gradient(90deg, #377dff 40%, #ff6f6f 100%);
      color: transparent;
      background-clip: text;
      -webkit-background-clip: text;
      margin-bottom: 2rem;
      text-align: center;
      letter-spacing: 2px;
    }
    .drop-box {
      border: 2px dashed #377dff;
      background: #fff;
      border-radius: 12px;
      padding: 2.2rem;
      text-align: center;
      transition: border-color 0.3s, box-shadow 0.3s;
      cursor: pointer;
      position: relative;
    }
    .drop-box.dragover {
      border-color: #ff6f6f;
      box-shadow: 0 0 0 4px #ffe;
    }
    .drop-box input[type="file"] {
      display: none;
    }
    .drop-box label {
      display: block;
      font-weight: 600;
      color: #377dff;
      cursor: pointer;
      font-size: 1.15rem;
      margin-bottom: 0.6rem;
    }
    .file-info { margin-top: 1rem; font-size:1.08em; font-weight:600; }
    .slider-label { font-weight: 500; margin-bottom: 0.3rem; }
    .slider-value { font-weight: 600; margin-left: 6px; }
    .img-thumb { max-width: 100px; margin: 6px; border-radius: 6px; box-shadow: 0 2px 10px #eee; }
    .btn-group { margin-bottom: 1rem; }
    .output-options { margin-bottom: 1rem; }
    .export-group { margin-top:7px; }
    #downloadArea a { margin-bottom: 7px; }
    .converted-info { font-size:1.03em; margin-bottom:5px; }
    .spinner-border { width: 1.1rem; height: 1.1rem; vertical-align: middle; margin-left: 7px; }
    .support-list { font-size: 0.95em; color: #888; margin-bottom: 0.5em; }
  </style>
</head>
<body>
<div class="container">
  <div class="fancy-title">PDF Toolkit — Compressor & Converter</div>
  <!-- Stylish File Input with Drag & Drop -->
  <div id="drop" class="drop-box mb-3">
    <label for="file">Choose PDF, Image or Office File<br>
      <span class="support-list">(Supported: PDF, JPG, PNG, BMP, AVIF, SVG, TIFF, HEIC, HEIF, WEBP, DOCX, PPTX, XLSX...)</span>
      <span style="font-size:0.95em;color:#888;">(or drag & drop here)</span>
    </label>
    <input id="file" type="file" accept=".pdf,.jpg,.jpeg,.png,.bmp,.avif,.svg,.tiff,.heic,.heif,.webp,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.odt,.ods,.odp,image/*,application/vnd.openxmlformats-officedocument.*,application/msword,application/vnd.ms-excel,application/vnd.ms-powerpoint" />
    <div id="fileInfo" class="file-info"></div>
  </div>

  <!-- Convert to PDF Section -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="mb-2">
        <label class="form-label">Convert to PDF:</label>
        <span class="support-list">(Input: PDF, JPG, PNG, BMP, AVIF, SVG, TIFF, HEIC, HEIF, WEBP, DOCX, PPTX, XLSX...)</span>
        <select id="pdfType" class="form-select">
          <option value="basic">Compress PDF (Basic)</option>
          <option value="ocr">OCR - Make PDF Searchable</option>
        </select>
      </div>
      <div class="mb-3" id="pdfSliderGroup">
        <label class="slider-label">Compression Quality:
          <span id="pdfQualityLabel" class="slider-value">80</span>
        </label>
        <input type="range" class="form-range" min="10" max="100" value="80" id="pdfQuality" />
        <div class="form-text">
          10 = Smallest file (low quality) — 100 = Largest file (best quality)
        </div>
      </div>
      <div class="d-flex align-items-center mb-2">
        <button id="goPDF" class="btn btn-primary me-2">Convert to PDF</button>
        <span id="pdfSpinner"></span>
        <span id="pdfDownloadArea"></span>
      </div>
      <div id="pdfConvertedInfo" class="converted-info"></div>
    </div>
  </div>

  <!-- Convert to Image Section -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="mb-2">
        <label class="form-label">Convert to Image:</label>
        <span class="support-list">(Input: PDF, JPG, PNG, BMP, AVIF, SVG, TIFF, HEIC, HEIF, WEBP)</span>
        <select id="imgfmt" class="form-select">
          <option value="png">PNG</option>
          <option value="jpg">JPG</option>
          <option value="jpeg">JPEG</option>
          <option value="webp">WEBP</option>
          <option value="avif">AVIF</option>
          <option value="heic">HEIC</option>
          <option value="heif">HEIF</option>
          <option value="svg">SVG</option>
          <option value="tiff">TIFF</option>
          <option value="bmp">BMP</option>
        </select>
      </div>
      <div class="mb-3" id="imgSliderGroup">
        <label class="slider-label">Compression Quality:
          <span id="imgQualityLabel" class="slider-value">80</span>
        </label>
        <input type="range" class="form-range" min="10" max="100" value="80" id="imgQuality" />
        <div class="form-text">
          10 = Smallest file (low quality) — 100 = Largest file (best quality)
        </div>
      </div>
      <div class="mb-2">
        <label class="form-label">Image Output Type:</label>
        <select id="imgouttype" class="form-select">
          <option value="images">Images (individual)</option>
          <option value="zip">Images (ZIP)</option>
        </select>
      </div>
      <div class="d-flex align-items-center mb-2">
        <button id="goIMG" class="btn btn-success me-2">Convert to Image</button>
        <span id="imgSpinner"></span>
        <span id="imgDownloadArea"></span>
      </div>
      <div id="imgConvertedInfo" class="converted-info"></div>
    </div>
  </div>

  <!-- Image to PDF Section -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="mb-2">
        <label class="form-label">Image to PDF:</label>
        <span class="support-list">(Input: JPG, PNG, BMP, AVIF, SVG, TIFF, HEIC, HEIF, WEBP)</span>
        <input type="file" id="imgFiles" multiple accept=".jpg,.jpeg,.png,.bmp,.avif,.svg,.tiff,.heic,.heif,.webp,image/*" class="form-control" />
        <div id="imgFilesInfo" class="file-info"></div>
      </div>
      <div class="mb-3">
        <label class="slider-label">Compression Quality:
          <span id="img2pdfSliderLabel" class="slider-value">80</span>
        </label>
        <input type="range" class="form-range" min="10" max="100" value="80" id="img2pdfQuality" />
        <div class="form-text">
          For JPEG/WEBP/AVIF images only. 10 = Smallest file, 100 = Best quality.
        </div>
      </div>
      <div class="d-flex align-items-center mb-2">
        <button id="img2pdfBtn" class="btn btn-primary me-2">Image to PDF</button>
        <span id="img2pdfSpinner"></span>
        <span id="img2pdfDownloadArea"></span>
      </div>
      <div id="img2pdfConvertedInfo" class="converted-info"></div>
    </div>
  </div>

  <!-- Office to PDF Section -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="mb-2">
        <label class="form-label">Office to PDF:</label>
        <span class="support-list">(Input: DOC, DOCX, PPT, PPTX, XLS, XLSX, ODT, ODS, ODP, etc.)</span>
        <input type="file" id="officeFile" accept=".doc,.docx,.ppt,.pptx,.xls,.xlsx,.odt,.ods,.odp,application/msword,application/vnd.openxmlformats-officedocument.*,application/vnd.ms-powerpoint,application/vnd.ms-excel" class="form-control" />
        <div id="officeFileInfo" class="file-info"></div>
      </div>
      <div class="d-flex align-items-center mb-2">
        <button id="office2pdfBtn" class="btn btn-warning me-2">Office to PDF</button>
        <span id="officeSpinner"></span>
        <span id="officeDownloadArea"></span>
      </div>
      <div id="officeConvertedInfo" class="converted-info"></div>
    </div>
  </div>

  <!-- Download areas for converted files -->
  <div id="downloadArea"></div>
</div>

<script>
  // Spinner helpers
  function showSpinner(spinnerId) {
    document.getElementById(spinnerId).innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
  }
  function hideSpinner(spinnerId) {
    document.getElementById(spinnerId).innerHTML = '';
  }

  // File details, input handlers remain unchanged
  let file = null;
  const fileInput = document.getElementById('file');
  const dropBox = document.getElementById('drop');
  const pdfQuality = document.getElementById('pdfQuality');
  const pdfQualityLabel = document.getElementById('pdfQualityLabel');
  const imgQuality = document.getElementById('imgQuality');
  const imgQualityLabel = document.getElementById('imgQualityLabel');
  const pdfTypeSelect = document.getElementById('pdfType');
  const pdfSliderGroup = document.getElementById('pdfSliderGroup');
  const img2pdfQuality = document.getElementById('img2pdfQuality');
  const img2pdfSliderLabel = document.getElementById('img2pdfSliderLabel');

  function showFileDetails(f, elid) {
    if (!f) { document.getElementById(elid).innerText = ''; return;}
    const kb = (f.size/1024).toFixed(2);
    document.getElementById(elid).innerText = `${f.name} (${kb} KB)`;
  }
  fileInput.addEventListener('change', function(e) {
    file = e.target.files[0];
    showFileDetails(file, 'fileInfo');
  });
  document.getElementById('imgFiles').addEventListener('change', function(e) {
    const files = e.target.files;
    let text = '';
    for (let i=0;i<files.length;i++) {
      text += `${files[i].name} (${(files[i].size/1024).toFixed(2)} KB)`;
      if (i<files.length-1) text += ', ';
    }
    document.getElementById('imgFilesInfo').innerText = text;
  });
  document.getElementById('officeFile').addEventListener('change', function(e) {
    const f = e.target.files[0];
    showFileDetails(f, 'officeFileInfo');
  });

  // Drag and Drop logic unchanged
  dropBox.addEventListener('dragover', function(e) {
    e.preventDefault();
    dropBox.classList.add('dragover');
  });
  dropBox.addEventListener('dragleave', function(e) {
    dropBox.classList.remove('dragover');
  });
  dropBox.addEventListener('drop', function(e) {
    e.preventDefault();
    dropBox.classList.remove('dragover');
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      file = e.dataTransfer.files[0];
      showFileDetails(file, 'fileInfo');
    }
  });

  // Sliders
  pdfQuality.addEventListener('input', function() { pdfQualityLabel.innerText = pdfQuality.value; });
  imgQuality.addEventListener('input', function() { imgQualityLabel.innerText = imgQuality.value; });
  img2pdfQuality.addEventListener('input', function() { img2pdfSliderLabel.innerText = img2pdfQuality.value; });

  // Hide PDF compression slider for OCR
  pdfTypeSelect.addEventListener('change', function() {
    if (pdfTypeSelect.value === 'ocr') pdfSliderGroup.style.display = 'none';
    else pdfSliderGroup.style.display = '';
  });

  function showConvertedInfo(areaId, fname, size) {
    document.getElementById(areaId).innerHTML =
      `<span>Converted File: <b>${fname}</b> (${(size/1024).toFixed(2)} KB)</span>`;
  }
  function createDownloadLink(areaId, blob, fname, label) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fname;
    a.className = "btn btn-info mt-2";
    a.innerText = label || "Download";
    document.getElementById(areaId).innerHTML = '';
    document.getElementById(areaId).appendChild(a);
    setTimeout(()=>URL.revokeObjectURL(url), 60000);
  }
  function showImageDownloads(imgs, sizes, areaId) {
    const area = document.getElementById(areaId);
    area.innerHTML = '';
    imgs.forEach((url, idx) => {
      const a = document.createElement('a');
      a.href = url;
      a.download = `page_${idx+1}.${document.getElementById('imgfmt').value}`;
      a.innerText = `Download page ${idx+1} (${(sizes[idx]/1024).toFixed(1)} KB)`;
      a.className = "btn btn-outline-success m-1";
      area.appendChild(a);
      area.appendChild(document.createElement('br'));
      const imgThumb = document.createElement('img');
      imgThumb.src = url;
      imgThumb.className = 'img-thumb';
      area.appendChild(imgThumb);
    });
  }

  // Remove log display (no bottom text during processing anymore)
  function log(msg) {
    // do nothing
  }

  // Convert to PDF
  document.getElementById('goPDF').addEventListener('click', async () => {
    if (!file) { alert('Select a PDF, Image or Office file first'); return; }
    showSpinner("pdfSpinner");
    document.getElementById('pdfDownloadArea').innerHTML = '';
    document.getElementById('pdfConvertedInfo').innerHTML = '';
    const form = new FormData();
    form.append('file', file);
    let endpoint = '';
    let params = {};
    if (pdfTypeSelect.value === 'basic') {
      endpoint = '/compress/basic';
      params = { quality: pdfQuality.value };
    } else if (pdfTypeSelect.value === 'ocr') {
      endpoint = '/ocr';
    }
    let url = endpoint;
    if (Object.keys(params).length) url += '?' + new URLSearchParams(params).toString();
    try {
      const resp = await fetch(url, { method: 'POST', body: form });
      if (!resp.ok) {
        hideSpinner("pdfSpinner");
        alert('Error: ' + resp.status + ' - ' + await resp.text());
        return;
      }
      const blob = await resp.blob();
      let fname = file.name.replace(/\.[^.]+$/,"") + ".pdf";
      const headerFilename = resp.headers.get('x-converted-filename');
      if (headerFilename) fname = headerFilename;
      showConvertedInfo("pdfConvertedInfo", fname, blob.size);
      createDownloadLink("pdfDownloadArea", blob, fname, "Download PDF");
      hideSpinner("pdfSpinner");
    } catch(e) {
      hideSpinner("pdfSpinner");
      alert("Error: " + e.message);
    }
  });

  // Convert to Image
  document.getElementById('goIMG').addEventListener('click', async () => {
    if (!file) { alert('Select a PDF or Image first'); return; }
    showSpinner("imgSpinner");
    document.getElementById('imgDownloadArea').innerHTML = '';
    document.getElementById('imgConvertedInfo').innerHTML = '';
    const form = new FormData();
    form.append('file', file);
    const fmt = document.getElementById('imgfmt').value;
    const outtype = document.getElementById('imgouttype').value;
    const imgQualityVal = imgQuality.value;
    let url = '/pdf-to-images?fmt=' + fmt + '&outtype=' + outtype + '&quality=' + imgQualityVal;
    try {
      const resp = await fetch(url, { method: 'POST', body: form });
      if (!resp.ok) {
        hideSpinner("imgSpinner");
        alert('Error: ' + resp.status + ' - ' + await resp.text());
        return;
      }
      if (outtype === "images") {
        const result = await resp.json();
        showConvertedInfo("imgConvertedInfo", file.name.replace(/\.[^.]+$/,'') + `_images.${fmt}`, result.sizes.reduce((a,b)=>a+b,0));
        showImageDownloads(result.images, result.sizes, "imgDownloadArea");
      } else {
        const blob = await resp.blob();
        let fname = file.name.replace(/\.[^.]+$/,'') + `_images.zip`;
        showConvertedInfo("imgConvertedInfo", fname, blob.size);
        createDownloadLink("imgDownloadArea", blob, fname, "Download ZIP");
      }
      hideSpinner("imgSpinner");
    } catch(e) {
      hideSpinner("imgSpinner");
      alert("Error: " + e.message);
    }
  });

  // Image to PDF
  document.getElementById('img2pdfQuality').addEventListener('input', function() {
    img2pdfSliderLabel.innerText = img2pdfQuality.value;
  });
  document.getElementById('img2pdfBtn').onclick = async () => {
    const files = document.getElementById('imgFiles').files;
    if (!files.length) { alert('Select images'); return; }
    showSpinner("img2pdfSpinner");
    document.getElementById('img2pdfDownloadArea').innerHTML = '';
    document.getElementById('img2pdfConvertedInfo').innerHTML = '';
    const form = new FormData();
    for (let i = 0; i < files.length; i++) { form.append('files', files[i]); }
    form.append('quality', img2pdfQuality.value);
    let fname = files[0].name.replace(/\.[^.]+$/,'') + "_images.pdf";
    try {
      const resp = await fetch('/images-to-pdf?quality=' + img2pdfQuality.value, { method: 'POST', body: form });
      if (!resp.ok) {
        hideSpinner("img2pdfSpinner");
        alert('Error: ' + resp.status + ' - ' + await resp.text());
        return;
      }
      const blob = await resp.blob();
      showConvertedInfo("img2pdfConvertedInfo", fname, blob.size);
      createDownloadLink("img2pdfDownloadArea", blob, fname, "Download PDF");
      hideSpinner("img2pdfSpinner");
    } catch(e) {
      hideSpinner("img2pdfSpinner");
      alert("Error: " + e.message);
    }
  };

  // Office to PDF
  document.getElementById('office2pdfBtn').onclick = async () => {
    const file = document.getElementById('officeFile').files[0];
    if (!file) { alert('Select office file'); return; }
    showSpinner("officeSpinner");
    document.getElementById('officeDownloadArea').innerHTML = '';
    document.getElementById('officeConvertedInfo').innerHTML = '';
    const form = new FormData();
    form.append('file', file);
    try {
      const resp = await fetch('/office-to-pdf', { method: 'POST', body: form });
      if (!resp.ok) {
        hideSpinner("officeSpinner");
        alert('Error: ' + resp.status + ' - ' + await resp.text());
        return;
      }
      const blob = await resp.blob();
      const headerFilename = resp.headers.get('x-converted-filename');
      const fname = headerFilename || file.name.replace(/\.[^.]+$/,'') + ".pdf";
      const fsize = resp.headers.get('x-converted-filesize') || blob.size;
      showConvertedInfo("officeConvertedInfo", fname, fsize);
      createDownloadLink("officeDownloadArea", blob, fname, "Download PDF");
      hideSpinner("officeSpinner");
    } catch(e) {
      hideSpinner("officeSpinner");
      alert("Error: " + e.message);
    }
  };
</script>
</body>
</html>